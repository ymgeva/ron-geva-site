---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getLangFromUrl, useTranslations } from '../../../utils/i18n';

export async function getStaticPaths() {
  const blogPosts = (await getCollection('blog'))
    .filter(post => !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return [
    {
      params: { lang: 'he' },
      props: { blogPosts },
    },
    {
      params: { lang: 'en' },
      props: { blogPosts },
    },
  ];
}

const { blogPosts } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const isRTL = lang === 'he';
---

<BaseLayout title={isRTL ? 'בלוג' : 'Blog'}>
  <div class={`max-w-7xl mx-auto px-4 py-8 ${isRTL ? 'rtl' : 'ltr'}`} dir={isRTL ? 'rtl' : 'ltr'}>
    <!-- Page header -->
    <header class="mb-12 text-center">
      <h1 class="text-5xl font-bold mb-4 font-alef">{isRTL ? 'בלוג' : 'Blog'}</h1>
      <p class="text-gray-600 text-lg font-alef">
        {isRTL ? 'מחשבות, רהורים וסיפורים מעולם היצירה' : 'Thoughts, reflections and stories from the world of creation'}
      </p>
    </header>

    <!-- Blog grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
      {blogPosts.map((post) => {
        const formattedDate = post.data.pubDate.toLocaleDateString(lang === 'he' ? 'he-IL' : 'en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        // Strip language prefix from slug (e.g., "he/filename" -> "filename")
        const cleanSlug = post.slug.replace(/^(he|en)\//,  '');

        return (
          <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
            {/* Featured image */}
            {post.data.featuredImage && (
              <a href={`/${lang}/blog/${cleanSlug}`}>
                <img
                  src={post.data.featuredImage}
                  alt={post.data.title}
                  class="w-full h-48 object-cover hover:opacity-90 transition-opacity"
                />
              </a>
            )}

            {/* Content */}
            <div class="p-6">
              {/* Title */}
              <h2 class="text-2xl font-bold mb-3 font-alef hover:text-gray-700 transition-colors">
                <a href={`/${lang}/blog/${cleanSlug}`}>
                  {post.data.title}
                </a>
              </h2>

              {/* Meta info */}
              <div class="flex flex-wrap gap-4 text-gray-600 text-sm mb-3">
                <span class="flex items-center gap-1">
                  <i class="far fa-calendar"></i>
                  {formattedDate}
                </span>
                <span class="flex items-center gap-1">
                  <i class="far fa-clock"></i>
                  {post.data.readingTime}
                </span>
              </div>

              {/* Description */}
              <p class="text-gray-700 mb-4 line-clamp-3 font-alef">
                {post.data.description}
              </p>

              {/* Counters */}
              <div class="flex gap-4 text-gray-500 text-sm pt-4 border-t border-gray-200">
                <span class="flex items-center gap-1">
                  <i class="far fa-eye"></i>
                  {post.data.views}
                </span>
                <span class="flex items-center gap-1">
                  <i class="far fa-comment"></i>
                  {post.data.comments}
                </span>
                <span class="flex items-center gap-1">
                  <i class="far fa-heart"></i>
                  {post.data.likes}
                </span>
              </div>
            </div>
          </article>
        );
      })}
    </div>
  </div>

  <style>
    /* RTL support */
    .rtl {
      direction: rtl;
      text-align: right;
    }

    .ltr {
      direction: ltr;
      text-align: left;
    }

    /* Line clamp utility */
    .line-clamp-3 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
    }

    /* Hover effect for cards */
    article {
      transition: transform 0.2s;
    }

    article:hover {
      transform: translateY(-4px);
    }
  </style>
</BaseLayout>
