---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Lightbox from '../../../components/Lightbox.astro';
import { getCollection, getEntry } from 'astro:content';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  const categories = await getCollection('art-categories');
  const locales = ['en', 'he'];
  
  const paths = [];
  for (const lang of locales) {
    for (const category of categories) {
      paths.push({
        params: { lang, category: category.data.slug },
      });
    }
  }
  
  return paths;
}

const { lang, category } = Astro.params;

// Redirect alligators to the dedicated alligators page
if (category === 'alligators') {
  return Astro.redirect(`/${lang}/alligators`);
}

// Load category metadata from content collection
const categoryEntry = await getEntry('art-categories', category as string);
if (!categoryEntry) {
  return Astro.redirect(`/${lang}/art`);
}

const title = categoryEntry.data.title[lang as 'he' | 'en'];

// Get list of images from the public/images/art/{category} directory
const imagesDir = path.join(process.cwd(), 'public', 'images', 'art', category as string);
let imageFiles: string[] = [];
try {
  imageFiles = fs.readdirSync(imagesDir)
    .filter(file => /\.(jpg|jpeg|png)$/i.test(file))
    .sort((a, b) => {
      const numA = parseInt(a.match(/\d+/)?.[0] || '0');
      const numB = parseInt(b.match(/\d+/)?.[0] || '0');
      return numA - numB;
    });
} catch (err) {
  console.error(`Failed to read images directory: ${imagesDir}`, err);
}

const images = imageFiles.map((file, i) => ({
  src: `/images/art/${category}/${file}`,
  alt: `${title} ${i + 1}`,
}));
---

<BaseLayout title={title}>
  <div class="container mx-auto px-4 py-12">
    <div class="mb-8">
      <a 
        href={`/${lang}/art`}
        class="text-gray-600 hover:text-gray-900 transition inline-flex items-center gap-2 mb-4"
      >
        <span class="text-xl">{lang === 'he' ? '→' : '←'}</span>
        {lang === 'he' ? 'חזרה לאומנות' : 'Back to Art'}
      </a>
      <h1 class="text-4xl">{title}</h1>
    </div>
    
    <!-- Masonry Grid Layout -->
    <div 
      class="columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-4 space-y-4"
      dir="ltr"
    >
      {images.map((image) => (
        <div class="break-inside-avoid">
          <img
            src={image.src}
            alt={image.alt}
            class="gallery-image w-full rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer"
            loading="lazy"
          />
        </div>
      ))}
    </div>
  </div>
  
  <Lightbox />
</BaseLayout>
